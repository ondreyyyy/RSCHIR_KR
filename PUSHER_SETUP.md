# Гайд по настройке и тестированию Pusher для real-time синхронизации

## Что такое Pusher?

Pusher — это сервис для real-time коммуникации через WebSockets. Он позволяет отправлять события с сервера на клиент в реальном времени без постоянных HTTP-запросов.

## Шаг 1: Регистрация в Pusher

1. Перейдите на сайт [https://pusher.com/](https://pusher.com/)
2. Нажмите кнопку **"Sign up"** (Регистрация)
3. Заполните форму регистрации:
   - Email
   - Пароль
   - Имя
4. Подтвердите email (проверьте почту)

## Шаг 2: Создание приложения

1. После входа в аккаунт вы увидите дашборд
2. Нажмите кнопку **"Create app"** или **"Channels apps"** → **"Create app"**
3. Заполните форму:
   - **App name**: `Game Profiles` (или любое другое имя)
   - **Cluster**: Выберите ближайший к вам регион:
     - `mt1` (US East) - для США
     - `eu` (Europe) - для Европы
     - `ap-southeast-1` (Asia Pacific) - для Азии
   - **Front-end tech**: Выберите `Vanilla JS` или `jQuery`
   - **Back-end tech**: Выберите `PHP`
4. Нажмите **"Create app"**

## Шаг 3: Получение ключей

1. После создания приложения вы автоматически попадёте на страницу **"App Keys"**
2. Здесь вы увидите следующие ключи:
   - **App ID** (например: `1234567`)
   - **Key** (например: `a1b2c3d4e5f6g7h8i9j0`)
   - **Secret** (например: `1a2b3c4d5e6f7g8h9i0j`)
   - **Cluster** (например: `mt1`)

3. **Скопируйте все эти значения** — они понадобятся для настройки проекта

## Шаг 4: Настройка проекта

1. Откройте файл `.env` в корне проекта
2. Замените пустые значения Pusher на полученные ключи:

```env
PUSHER_APP_ID=1234567
PUSHER_KEY=a1b2c3d4e5f6g7h8i9j0
PUSHER_SECRET=1a2b3c4d5e6f7g8h9i0j
PUSHER_CLUSTER=mt1
```

**Важно**: 
- Не используйте кавычки вокруг значений
- Не добавляйте пробелы вокруг знака `=`
- Значения должны быть точными копиями из дашборда Pusher

3. Сохраните файл `.env`

## Шаг 5: Перезапуск сервера

После изменения `.env` файла нужно перезапустить PHP сервер:

1. Остановите текущий сервер (Ctrl+C в терминале)
2. Запустите снова:
   ```powershell
   php -S localhost:8000 -t public
   ```

## Шаг 6: Тестирование real-time синхронизации

### Вариант 1: Использование готовой страницы для тестирования

1. Откройте в браузере: `http://localhost:8000/realtime-test.html`
2. В поля введите:
   - **Pusher Key**: ваш `PUSHER_KEY` из `.env`
   - **Pusher Cluster**: ваш `PUSHER_CLUSTER` из `.env` (например: `mt1`)
3. Нажмите кнопку **"Подключиться"**
4. Должен появиться статус **"Подключено к Pusher"**

5. Теперь откройте в **другой вкладке** браузера: `http://localhost:8000/ui.php`
6. Обновите статистику любого профиля через форму **"Обновить статистику профиля"**
7. Вернитесь на вкладку с `realtime-test.html` — вы должны увидеть событие в списке событий!

### Вариант 2: Ручное тестирование через консоль браузера

1. Откройте `http://localhost:8000/ui.php`
2. Откройте консоль разработчика (F12)
3. Вставьте следующий код:

```javascript
// Загружаем Pusher SDK
const script = document.createElement('script');
script.src = 'https://js.pusher.com/8.2.0/pusher.min.js';
script.onload = function() {
    // Получаем конфигурацию с сервера
    fetch('http://localhost:8000/pusher-config')
        .then(res => res.json())
        .then(config => {
            // Подключаемся к Pusher
            const pusher = new Pusher(config.key, {
                cluster: config.cluster,
                encrypted: true
            });
            
            // Подписываемся на канал
            const channel = pusher.subscribe('profiles');
            
            // Слушаем события обновления статистики
            channel.bind('stats.updated', function(data) {
                console.log('Получено событие обновления статистики:', data);
                alert('Статистика обновлена для профиля: ' + data.nickname);
            });
            
            console.log('Подключено к Pusher! Ожидаю события...');
        });
};
document.head.appendChild(script);
```

4. Теперь обновите статистику профиля через форму
5. В консоли должно появиться сообщение с данными события

## Шаг 7: Проверка работы

### Что должно происходить:

1. ✅ При обновлении статистики профиля через форму, данные сохраняются в БД
2. ✅ Одновременно отправляется событие в Pusher
3. ✅ Все подключённые клиенты (открытые вкладки с `realtime-test.html`) получают событие в реальном времени
4. ✅ Событие содержит данные профиля: id, external_id, nickname, stats

### Отладка проблем:

**Проблема**: События не приходят
- Проверьте, что ключи в `.env` правильные
- Проверьте, что сервер перезапущен после изменения `.env`
- Откройте консоль браузера (F12) и проверьте ошибки
- Убедитесь, что кластер в `.env` совпадает с кластером в дашборде Pusher

**Проблема**: Ошибка 404 при обновлении статистики
- Это означает, что Pusher не может отправить событие
- Проверьте ключи в `.env`
- Проверьте, что приложение в Pusher активно (не удалено)

**Проблема**: SSL ошибки
- Убедитесь, что вы настроили SSL сертификаты в `php.ini`
- Или временно используйте опцию `PUSHER_DISABLE_SSL_VERIFY=true` в `.env` (только для разработки!)

## Дополнительная информация

- **Официальная документация Pusher**: https://pusher.com/docs/
- **Pusher PHP SDK**: https://github.com/pusher/pusher-http-php
- **Pusher JavaScript SDK**: https://github.com/pusher/pusher-js

## Бесплатный план Pusher

Pusher предоставляет бесплатный план с ограничениями:
- До 200,000 сообщений в день
- До 100 одновременных подключений
- До 10 каналов

Этого более чем достаточно для тестирования и курсовой работы!

