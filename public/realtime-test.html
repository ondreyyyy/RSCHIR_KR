<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .status.error {
            background: #fff3cd;
            color: #856404;
        }
        .events {
            margin-top: 20px;
        }
        .event {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .event-time {
            color: #666;
            font-size: 0.9em;
        }
        .event-data {
            margin-top: 10px;
            font-family: monospace;
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .instructions {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>
        
        <div class="instructions">
            <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:</h3>
            <ol>
                <li>–í–≤–µ–¥–∏ –∫–ª—é—á–∏ Pusher –Ω–∏–∂–µ (–∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∞ –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)</li>
                <li>–ù–∞–∂–º–∏ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Pusher"</li>
                <li>–û—Ç–∫—Ä–æ–π –≤ –¥—Ä—É–≥–æ–º –æ–∫–Ω–µ/–≤–∫–ª–∞–¥–∫–µ: <a href="ui.php" target="_blank">ui.php</a></li>
                <li>–í ui.php –æ–±–Ω–æ–≤–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ª—é–±–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è</li>
                <li>–í–µ—Ä–Ω–∏—Å—å —Å—é–¥–∞ - —Ç—ã —É–≤–∏–¥–∏—à—å —Å–æ–±—ã—Ç–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!</li>
            </ol>
        </div>

        <div>
            <label>Pusher Key: <input type="text" id="pusherKey" placeholder="—Ç–≤–æ–π_key"></label><br>
            <label>Pusher Cluster: <input type="text" id="pusherCluster" placeholder="mt1" value="mt1"></label><br>
            <button id="connectBtn" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Pusher</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>

        <div id="status" class="status disconnected">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>

        <div class="events">
            <h2>–°–æ–±—ã—Ç–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:</h2>
            <div id="eventsList"></div>
        </div>
    </div>

    <!-- Pusher JS SDK -->
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    
    <script>
        let pusher = null;
        let channel = null;

        function connect() {
            const key = document.getElementById('pusherKey').value;
            const cluster = document.getElementById('pusherCluster').value || 'mt1';

            if (!key) {
                alert('–í–≤–µ–¥–∏ Pusher Key! –ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ—Ç –∫–ª—é—á–µ–π, –º–æ–∂–µ—à—å:\n1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ https://dashboard.pusher.com/\n2. –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏ –≤ .env –∏ —Å—é–¥–∞');
                return;
            }

            //–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
            if (pusher) {
                disconnect();
            }

            try {
                //–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è pusher
                pusher = new Pusher(key, {
                    cluster: cluster,
                    encrypted: true
                });

                //–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
                updateStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Pusher');

                //–ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª profiles
                channel = pusher.subscribe('profiles');
                
                //–ø—Ä–æ—Å–ª—É—à–µ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π stats updated
                channel.bind('stats.updated', function(data) {
                    addEvent(data);
                });

                //–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                pusher.connection.bind('connected', function() {
                    updateStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Pusher');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                });

                //–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
                pusher.connection.bind('disconnected', function() {
                    updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç Pusher');
                });

                //–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                pusher.connection.bind('error', function(err) {
                    updateStatus('error', '–û—à–∏–±–∫–∞: ' + err.error.message);
                });

            } catch (error) {
                updateStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        }

        function disconnect() {
            if (pusher) {
                pusher.disconnect();
                pusher = null;
                channel = null;
                updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            }
        }

        function updateStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + type;
            statusDiv.textContent = message;
        }

        function addEvent(data) {
            const eventsList = document.getElementById('eventsList');
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event';
            
            const time = new Date().toLocaleTimeString('ru-RU');
            eventDiv.innerHTML = `
                <div class="event-time">üïê ${time}</div>
                <div><strong>–°–æ–±—ã—Ç–∏–µ:</strong> stats.updated</div>
                <div><strong>–ü—Ä–æ—Ñ–∏–ª—å:</strong> ${data.nickname} (ID: ${data.id})</div>
                <div class="event-data">${JSON.stringify(data, null, 2)}</div>
            `;
            
            eventsList.insertBefore(eventDiv, eventsList.firstChild);
        }

        //–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–π –∏–∑ api
        window.addEventListener('load', function() {
            //–ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ api
            fetch('/pusher-config')
                .then(response => response.json())
                .then(data => {
                    if (data.key) {
                        document.getElementById('pusherKey').value = data.key;
                    }
                    if (data.cluster) {
                        document.getElementById('pusherCluster').value = data.cluster;
                    }
                })
                .catch(() => {
                    //–µ—Å–ª–∏ api –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localstorage
                    const savedKey = localStorage.getItem('pusherKey');
                    const savedCluster = localStorage.getItem('pusherCluster');
                    if (savedKey) {
                        document.getElementById('pusherKey').value = savedKey;
                    }
                    if (savedCluster) {
                        document.getElementById('pusherCluster').value = savedCluster;
                    }
                });
        });

        //—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π –≤ localstorage
        document.getElementById('connectBtn').addEventListener('click', function() {
            const key = document.getElementById('pusherKey').value;
            const cluster = document.getElementById('pusherCluster').value;
            if (key) localStorage.setItem('pusherKey', key);
            if (cluster) localStorage.setItem('pusherCluster', cluster);
        });
    </script>
</body>
</html>

